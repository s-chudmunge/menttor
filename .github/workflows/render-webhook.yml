name: Trigger Render Deploy

on:
  push:
    branches: [ master ]
    paths:
      - 'backend/**'
      - 'render.yaml'
  workflow_dispatch:

jobs:
  trigger-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Trigger Render Deploy
      run: |
        curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
        echo "✅ Render deployment triggered"

    - name: Wait and Health Check
      run: |
        echo "Waiting for deployment to complete..."
        sleep 60
        
        # Health check with retries
        for i in {1..5}; do
          if curl -f https://menttor-backend.onrender.com/health; then
            echo "✅ Health check passed on attempt $i"
            exit 0
          fi
          echo "❌ Health check failed on attempt $i, retrying in 30s..."
          sleep 30
        done
        
        echo "❌ Health check failed after 5 attempts"
        exit 1