name: Deploy Backend to Cloud Run

on:
  push:
    branches: [ master ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

env:
  PROJECT_ID: gen-lang-client-0319118634
  REGION: asia-south1
  SERVICE_NAME: menttor-backend
  REGISTRY_LOCATION: asia-south1
  REPOSITORY: menttor-repo

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install basic dependencies for syntax check
      run: |
        cd backend
        pip install fastapi sqlmodel pydantic pydantic-settings python-dotenv

    - name: Basic syntax check
      run: |
        cd backend
        export PYTHONPATH=$PWD/app
        python -m py_compile app/main.py
        python -c "import sys; sys.path.append('app'); from sql_models import *; print('âœ… Models import successfully')"
        echo "âœ… Basic syntax validation passed"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGISTRY_LOCATION }}-docker.pkg.dev

    - name: Build Docker image
      run: |
        cd backend
        docker build -t ${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} .
        docker tag ${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} ${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:latest

    - name: Push Docker image
      run: |
        docker push ${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:latest

    - name: Deploy to Cloud Run
      run: |
        # Deploy to Cloud Run with direct database connection (no Cloud SQL Auth Proxy)
        # POSTGRES_HOST now uses direct IP address for simplified connectivity
        # Note: POSTGRES_PORT defaults to 5432 if secret is empty (fixed deployment issue 2025-09-09)
        # All sensitive data now securely managed via Google Secret Manager for production security
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --image ${{ env.REGISTRY_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.SERVICE_NAME }}:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --min-instances=1 \
          --max-instances=3 \
          --memory=2Gi \
          --cpu=1 \
          --timeout=300 \
          --set-env-vars="GOOGLE_CLOUD_PROJECT_ID=${{ env.PROJECT_ID }},ENVIRONMENT=production,DATABASE_ECHO=false,POSTGRES_PORT=5432,VERTEX_AI_PROJECT_ID=${{ env.PROJECT_ID }},VERTEX_AI_REGION=us-central1,VERTEX_AI_MODEL_ID=gemini-2.5-flash-lite,FIREBASE_PROJECT_ID=${{ env.PROJECT_ID }}" \
          --set-secrets="POSTGRES_USER=postgres-user:latest,POSTGRES_PASSWORD=postgres-password:latest,POSTGRES_DB=postgres-db:latest,POSTGRES_HOST=postgres-host:latest,FIREBASE_CLIENT_EMAIL=firebase-client-email:latest,FIREBASE_CLIENT_ID=firebase-client-id:latest,GOOGLE_CLIENT_ID=google-client-id:latest,GOOGLE_CLIENT_SECRET=google-client-secret:latest,REDIS_URL=redis-url:latest,OPENROUTER_API_KEY=openrouter-api-key:latest,HUGGINGFACE_HUB_TOKEN=huggingface-hub-token:latest,SECRET_KEY=secret-key:latest,REFRESH_SECRET_KEY=refresh-secret-key:latest,FIREBASE_CREDENTIALS=firebase-service-account:latest"

    - name: Verify deployment
      run: |
        SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} --region=${{ env.REGION }} --format='value(status.url)')
        echo "Service deployed at: $SERVICE_URL"
        
        # Test health endpoint
        curl -f "$SERVICE_URL/health" || exit 1
        echo "âœ… Health check passed"

    - name: Post-deployment notification
      if: success()
      run: |
        echo "ðŸš€ Backend successfully deployed to Cloud Run"
        echo "ðŸ“Š Using CI/CD-safe auto-migrations that preserve all user data"